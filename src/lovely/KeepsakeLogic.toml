[manifest]
version = "1.0.0"
priority = 0

[[patches]]
[patches.pattern]
target = "KeepsakeLogic.lua"
pattern = "function OpenKeepsakeRackScreen( source )"
position = "before"
payload = '''
local keyMaxVisibleKeepsakes = "zannc-KeepsakeExtender-MaxVisibleKeepsakes"
local keyScrollOffset = "zannc-KeepsakeExtender-ScrollOffset"
local keyScrollUp = "zannc-KeepsakeExtender-ScrollUp"
local keyScrollDown = "zannc-KeepsakeExtender-ScrollDown"

local activeKeepsakeIDs, disabledKeepsakeIDs = {}, {}
local scrollArrowXPositions = { 158, 275, 390, 510, 620, 733, 850, 970, 1085, 1195, 1314 }

function createScrollArrowData(x, isUpArrow)
	return {
		Graphic = isUpArrow and "ButtonCodexUp" or "ButtonCodexDown",
		GroupName = "Combat_Menu_Overlay",
		X = x,
		Y = isUpArrow and 120 or 700,
		Alpha = 0.0,
		Scale = 1.0,
		InputBlockDuration = 0.02,
		Data = {
			OnPressedFunctionName = isUpArrow and function(...)
				return KeepsakeScrollUp(...)
			end or function(...)
				return KeepsakeScrollDown(...)
			end,
			ControlHotkey = isUpArrow and "MenuUp" or "MenuDown",
		},
	}
end

function initKeepsakeRackScreen(screen)
	screen[keyMaxVisibleKeepsakes] = 33
	screen[keyScrollOffset] = 0

	for i, x in ipairs(scrollArrowXPositions) do
		local upKey = keyScrollUp .. i
		local downKey = keyScrollDown .. i

		screen.ComponentData[upKey] = createScrollArrowData(x, true)
		screen.ComponentData[downKey] = createScrollArrowData(x, false)

		table.insert(screen.ComponentData.Order, upKey)
		table.insert(screen.ComponentData.Order, downKey)
	end
end

function checkForCurrentKeepsake(screen)
	if not screen.LastTrait then
		return
	end

	local foundSelected = false

	for _, buttonKey in ipairs(screen.ActiveEntries) do
		local component = screen.Components[buttonKey]
		local isVisible = false
		for _, id in ipairs(activeKeepsakeIDs) do
			if component.Id == id then
				isVisible = true
				break
			end
		end

		if component and component.Data and component.Data.Gift == (GameState.LastAwardTrait or screen.LastTrait) and isVisible then
			TeleportCursor({ OffsetX = component.OffsetX, OffsetY = component.OffsetY, ForceUseCheck = true })
			SetSelectedFrame(screen, component, { RestartAnimation = true })
			KeepsakeScreenShowInfo(screen, screen.Components[buttonKey])
			foundSelected = true
			break
		else
			SetAlpha({ Id = screen.Components.EquippedFrame.Id, Fraction = 0.0, Duration = 0.1 })
		end
	end

	if not foundSelected then
		local firstVisibleIndex = math.min(screen[keyScrollOffset] + 1, #screen.ActiveEntries)
		local firstButtonKey = screen.ActiveEntries[firstVisibleIndex]
		local firstComponent = screen.Components[firstButtonKey]
		if firstComponent then
			TeleportCursor({ OffsetX = firstComponent.OffsetX, OffsetY = firstComponent.OffsetY, ForceUseCheck = true })
			KeepsakeScreenShowInfo(screen, firstComponent)
		end
	end
end

function KeepsakeUpdateVisibility(screen, args)
	args = args or {}
	activeKeepsakeIDs, disabledKeepsakeIDs = {}, {}
	local components = screen.Components

	local rowMin = math.ceil(screen.RowMax / 2)

	local startIndex = screen[keyScrollOffset] + 1
	local endIndex = math.min(screen[keyScrollOffset] + screen[keyMaxVisibleKeepsakes], #screen.ActiveEntries)

	local componentOffsetList = {
		Frame = { offsetx = 0, offsety = 10 },
		Bar = { offsetx = 0, offsety = 80 },
		BarFill = { offsetx = 0, offsety = 80 },
		Rank = { offsetx = 0, offsety = screen.RankOffsetY },
		Sticker = { offsetx = 30, offsety = -40 },
		Lock = { offsetx = 0, offsety = 0 },
	}

	local favouriteKeepsakeVisible = false
	local favouriteButtonKey = nil

	for index, buttonKey in ipairs(screen.ActiveEntries) do
		local item = components[buttonKey]
		if item ~= nil and GameState.SaveFirstKeepsakeName == item.Data.Gift then
			if index >= startIndex and index <= endIndex then
				favouriteKeepsakeVisible = true
				favouriteButtonKey = buttonKey
				break
			end
		end
	end

	for index, buttonKey in ipairs(screen.ActiveEntries) do
		local item = components[buttonKey]

		if item ~= nil then
			if index >= startIndex and index <= endIndex then
				local x = screen.StartX - screen.SpacerX * rowMin / 2 + ((index - 1) % screen.RowMax + 0.5) * screen.SpacerX
				local y = screen.StartY + math.floor((index - startIndex) / screen.RowMax) * 2 * (screen.SpacerY / 2)

				item.OffsetX = x
				item.OffsetY = y

				-- TP the Keepsake Textures like selected texture
				Teleport({ Id = item.Id, OffsetX = x, OffsetY = y })

				for k, v in pairs(componentOffsetList) do
					if components[buttonKey .. k] then
						Teleport({ Id = components[buttonKey .. k].Id, OffsetX = x + v.offsetx, OffsetY = y + v.offsety })
					end
				end

				if item.NewIcon then
					Teleport({ Id = item.NewIcon.Id, OffsetX = x, OffsetY = y - 30 })
				end

				-- Add Keepsakes to list to be shown later
				table.insert(activeKeepsakeIDs, item.Id)

				for k, v in pairs(componentOffsetList) do
					if components[buttonKey .. k] then
						if k ~= "Bar" and k ~= "BarFill" then
							table.insert(activeKeepsakeIDs, components[buttonKey .. k].Id)
						end
					end
				end

				if item.NewIcon then
					table.insert(activeKeepsakeIDs, item.NewIcon.Id)
				end
			else
				table.insert(disabledKeepsakeIDs, item.Id)
				for k, v in pairs(componentOffsetList) do
					if components[buttonKey .. k] then
						table.insert(disabledKeepsakeIDs, components[buttonKey .. k].Id)
					end
				end
				if item.NewIcon then
					table.insert(disabledKeepsakeIDs, item.NewIcon.Id)
				end
			end

			if GameState.SaveFirstKeepsakeName == item.Data.Gift then
				if favouriteKeepsakeVisible and buttonKey == favouriteButtonKey then
					SetSaveFirstIcon(screen, components[buttonKey])
				else
					ClearSaveFirstIcon(screen, components[buttonKey])
				end
			end
		end
	end

	SetAlpha({ Ids = activeKeepsakeIDs, Fraction = 1, Duration = 0.1 })
	UseableOn({ Ids = activeKeepsakeIDs })

	SetAlpha({ Ids = disabledKeepsakeIDs, Fraction = 0, Duration = 0.1 })
	UseableOff({ Ids = disabledKeepsakeIDs, ForceHighlightOff = true })

	if not args.IgnoreArrows then
		local canScrollUp = screen[keyScrollOffset] > 0
		local canScrollDown = screen[keyScrollOffset] + screen[keyMaxVisibleKeepsakes] < screen.NumItems

		for i, x in ipairs(scrollArrowXPositions) do
			local upKey = keyScrollUp .. i
			local downKey = keyScrollDown .. i

			if x == 733 then
				if components[upKey] then
					if canScrollUp then
						SetAlpha({ Id = components[upKey].Id, Fraction = 1.0, Duration = 0.1 })
						UseableOn({ Id = components[upKey].Id })
					else
						SetAlpha({ Id = components[upKey].Id, Fraction = 0.3, Duration = 0.1 })
						UseableOff({ Id = components[upKey].Id, ForceHighlightOff = true })
					end
				end

				if components[downKey] then
					if canScrollDown then
						SetAlpha({ Id = components[downKey].Id, Fraction = 1.0, Duration = 0.1 })
						UseableOn({ Id = components[downKey].Id })
					else
						SetAlpha({ Id = components[downKey].Id, Fraction = 0.3, Duration = 0.1 })
						UseableOff({ Id = components[downKey].Id, ForceHighlightOff = true })
					end
				end
			else
				if components[upKey] then
					if canScrollUp then
						UseableOn({ Id = components[upKey].Id })
					else
						UseableOff({ Id = components[upKey].Id, ForceHighlightOff = true })
					end
				end

				if components[downKey] then
					if canScrollDown then
						UseableOn({ Id = components[downKey].Id })
					else
						UseableOff({ Id = components[downKey].Id, ForceHighlightOff = true })
					end
				end
			end
		end
	end
end

function KeepsakeScrollUp(screen, button)
	if screen[keyScrollOffset] <= 0 then
		return
	end
	screen[keyScrollOffset] = screen[keyScrollOffset] - screen[keyMaxVisibleKeepsakes]
	GenericScrollPresentation(screen, button)
	KeepsakeUpdateVisibility(screen, { ScrolledUp = true })

	wait(0.02)

	checkForCurrentKeepsake(screen)
end

function KeepsakeScrollDown(screen, button)
	if screen[keyScrollOffset] + screen[keyMaxVisibleKeepsakes] >= screen.NumItems then
		return
	end
	screen[keyScrollOffset] = screen[keyScrollOffset] + screen[keyMaxVisibleKeepsakes]
	GenericScrollPresentation(screen, button)
	KeepsakeUpdateVisibility(screen, { ScrolledDown = true })
	wait(0.02)
	checkForCurrentKeepsake(screen)
end

'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "KeepsakeLogic.lua"
pattern = '''
function OpenKeepsakeRackScreen( source )
	local screen = DeepCopyTable( ScreenData.KeepsakeRack )
'''
position = "after"
payload = '''
initKeepsakeRackScreen(screen)
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = "KeepsakeLogic.lua"
pattern = '''
	wait( 0.2 )
	for itemIndex, itemName in ipairs( screen.ItemOrder ) do

		local keepsakeData = GetKeepsakeData( itemName )
		if keepsakeData ~= nil then
			local itemData =
			{
				New = GameState.NewKeepsakeItem[keepsakeData.GiftLevelData.Gift],
				Gift = itemName,
				Level = 1,
				NPC = keepsakeData.NPCName,
				Unlocked = SessionState.AllKeepsakeUnlocked or IsGameStateEligible( keepsakeData.GiftLevelData, keepsakeData.GiftLevelData.GameStateRequirements )
			}

			local localx = 0
			local localy = 0
			localx = screen.StartX - screen.SpacerX * rowMin/2 + ((itemIndex - 1) % screen.RowMax + 0.5) * screen.SpacerX
			localy = screen.StartY + math.floor( (itemIndex - 1) / screen.RowMax)* 2 * (screen.SpacerY / 2)
			CreateKeepsakeIcon( screen, components, { Index = itemIndex, UpgradeData = itemData, X = localx, Y = localy } )
		end
	end
    '''
position = "at"
payload = '''
screen.ActiveEntries = {}
screen.NumItems = 0
screen[keyScrollOffset] = 0
local numEntries = #screen.ItemOrder
wait(0.2)

for i = 1, numEntries do
    local entryName = screen.ItemOrder[i]
    local keepsakeData = GetKeepsakeData(entryName)

    if keepsakeData ~= nil then
        local itemData = {
            New = GameState.NewKeepsakeItem[keepsakeData.GiftLevelData.Gift],
            Gift = entryName,
            Level = 1,
            NPC = keepsakeData.NPCName,
            Unlocked = SessionState.AllKeepsakeUnlocked or IsGameStateEligible(keepsakeData.GiftLevelData, keepsakeData.GiftLevelData.GameStateRequirements),
        }

        local buttonKey = "UpgradeToggle" .. i
        CreateKeepsakeIcon(screen, components, { Index = i, UpgradeData = itemData, X = screen.StartX, Y = screen.StartY, Alpha = 0.0 })

        local button = components[buttonKey]
        if button then
            local stickerKey = buttonKey .. "Sticker"
            if components[stickerKey] then
                SetAlpha({ Id = components[stickerKey].Id, Fraction = 0.0, Duration = 0.0 })
            end
        end

        screen.NumItems = screen.NumItems + 1
        table.insert(screen.ActiveEntries, buttonKey)
    end
end

KeepsakeUpdateVisibility(screen)
checkForCurrentKeepsake(screen)
'''
match_indent = true
times = 1
